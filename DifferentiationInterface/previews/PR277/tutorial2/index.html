<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Sparsity · DifferentiationInterface.jl</title><meta name="title" content="Sparsity · DifferentiationInterface.jl"/><meta property="og:title" content="Sparsity · DifferentiationInterface.jl"/><meta property="twitter:title" content="Sparsity · DifferentiationInterface.jl"/><meta name="description" content="Documentation for DifferentiationInterface.jl."/><meta property="og:description" content="Documentation for DifferentiationInterface.jl."/><meta property="twitter:description" content="Documentation for DifferentiationInterface.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="DifferentiationInterface.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">DifferentiationInterface.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../tutorial1/">Basics</a></li><li class="is-active"><a class="tocitem" href>Sparsity</a><ul class="internal"><li><a class="tocitem" href="#Dense-backends"><span>Dense backends</span></a></li><li><a class="tocitem" href="#Sparse-backends"><span>Sparse backends</span></a></li><li><a class="tocitem" href="#Sparse-preparation"><span>Sparse preparation</span></a></li></ul></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../operators/">Operators</a></li><li><a class="tocitem" href="../backends/">Backends</a></li><li><a class="tocitem" href="../api/">API</a></li></ul></li><li><span class="tocitem">Advanced</span><ul><li><a class="tocitem" href="../preparation/">Preparation</a></li><li><a class="tocitem" href="../overloads/">Overloads</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Sparsity</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Sparsity</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/gdalle/DifferentiationInterface.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/gdalle/DifferentiationInterface.jl/blob/main/DifferentiationInterface/docs/src/tutorial2.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Sparsity"><a class="docs-heading-anchor" href="#Sparsity">Sparsity</a><a id="Sparsity-1"></a><a class="docs-heading-anchor-permalink" href="#Sparsity" title="Permalink"></a></h1><p>We present sparsity handling with DifferentiationInterface.jl.</p><pre><code class="language-julia hljs">using BenchmarkTools
using DifferentiationInterface
import ForwardDiff, Zygote</code></pre><p>Sparse AD is very useful when Jacobian or Hessian matrices have a lot of zeros. So let us write functions that satisfy this property.</p><pre><code class="language-julia hljs">f_sparse_vector(x::AbstractVector) = diff(x .^ 2) + diff(reverse(x .^ 2))
f_sparse_scalar(x::AbstractVector) = sum(f_sparse_vector(x) .^ 2)</code></pre><h2 id="Dense-backends"><a class="docs-heading-anchor" href="#Dense-backends">Dense backends</a><a id="Dense-backends-1"></a><a class="docs-heading-anchor-permalink" href="#Dense-backends" title="Permalink"></a></h2><p>When we use the <a href="../api/#DifferentiationInterface.jacobian"><code>jacobian</code></a> or <a href="../api/#DifferentiationInterface.hessian"><code>hessian</code></a> operator with a dense backend, we get a dense matrix with plenty of zeros.</p><pre><code class="language-julia hljs">dense_first_order_backend = AutoForwardDiff()
J_dense = jacobian(f_sparse_vector, dense_first_order_backend, float.(1:10))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">9×10 Matrix{Float64}:
 -2.0   4.0   0.0   0.0    0.0    0.0    0.0    0.0   18.0  -20.0
  0.0  -4.0   6.0   0.0    0.0    0.0    0.0   16.0  -18.0    0.0
  0.0   0.0  -6.0   8.0    0.0    0.0   14.0  -16.0    0.0    0.0
  0.0   0.0   0.0  -8.0   10.0   12.0  -14.0    0.0    0.0    0.0
  0.0   0.0   0.0   0.0    0.0    0.0    0.0    0.0    0.0    0.0
  0.0   0.0   0.0   8.0  -10.0  -12.0   14.0    0.0    0.0    0.0
  0.0   0.0   6.0  -8.0    0.0    0.0  -14.0   16.0    0.0    0.0
  0.0   4.0  -6.0   0.0    0.0    0.0    0.0  -16.0   18.0    0.0
  2.0  -4.0   0.0   0.0    0.0    0.0    0.0    0.0  -18.0   20.0</code></pre><pre><code class="language-julia hljs">dense_second_order_backend = SecondOrder(AutoForwardDiff(), AutoZygote())
H_dense = hessian(f_sparse_scalar, dense_second_order_backend, float.(1:10))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">10×10 Matrix{Float64}:
  144.0   -32.0     0.0     0.0     0.0  …     0.0      0.0   -144.0    160.0
  -32.0    96.0   -96.0     0.0     0.0        0.0   -256.0    576.0   -320.0
    0.0   -96.0   256.0  -192.0     0.0     -336.0    768.0   -432.0      0.0
    0.0     0.0  -192.0   480.0  -320.0      896.0   -512.0      0.0      0.0
    0.0     0.0     0.0  -320.0   368.0     -560.0      0.0      0.0      0.0
    0.0     0.0     0.0  -384.0   480.0  …  -672.0      0.0      0.0      0.0
    0.0     0.0  -336.0   896.0  -560.0     1536.0   -896.0      0.0      0.0
    0.0  -256.0   768.0  -512.0     0.0     -896.0   2016.0  -1152.0      0.0
 -144.0   576.0  -432.0     0.0     0.0        0.0  -1152.0   2560.0  -1440.0
  160.0  -320.0     0.0     0.0     0.0        0.0      0.0  -1440.0   1728.0</code></pre><p>The results are correct but the procedure is very slow. By using a sparse backend, we can get the runtime to increase with the number of nonzero elements, instead of the total number of elements.</p><h2 id="Sparse-backends"><a class="docs-heading-anchor" href="#Sparse-backends">Sparse backends</a><a id="Sparse-backends-1"></a><a class="docs-heading-anchor-permalink" href="#Sparse-backends" title="Permalink"></a></h2><p>Recipe to create a sparse backend: combine a dense backend, a sparsity detector and a coloring algorithm inside <a href="https://sciml.github.io/ADTypes.jl/stable/#ADTypes.AutoSparse"><code>AutoSparse</code></a>. The following are reasonable defaults:</p><pre><code class="language-julia hljs">using SparseConnectivityTracer: TracerSparsityDetector
using SparseMatrixColorings: GreedyColoringAlgorithm

sparse_first_order_backend = AutoSparse(
    AutoForwardDiff();
    sparsity_detector=TracerSparsityDetector(),
    coloring_algorithm=GreedyColoringAlgorithm(),
)

sparse_second_order_backend = AutoSparse(
    SecondOrder(AutoForwardDiff(), AutoZygote());
    sparsity_detector=TracerSparsityDetector(),
    coloring_algorithm=GreedyColoringAlgorithm(),
)</code></pre><p>Now the resulting matrices are sparse:</p><pre><code class="language-julia hljs">jacobian(f_sparse_vector, sparse_first_order_backend, float.(1:10))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">9×10 SparseArrays.SparseMatrixCSC{Float64, Int64} with 34 stored entries:
 -2.0   4.0    ⋅     ⋅      ⋅      ⋅      ⋅      ⋅    18.0  -20.0
   ⋅   -4.0   6.0    ⋅      ⋅      ⋅      ⋅    16.0  -18.0     ⋅ 
   ⋅     ⋅   -6.0   8.0     ⋅      ⋅    14.0  -16.0     ⋅      ⋅ 
   ⋅     ⋅     ⋅   -8.0   10.0   12.0  -14.0     ⋅      ⋅      ⋅ 
   ⋅     ⋅     ⋅     ⋅     0.0    0.0     ⋅      ⋅      ⋅      ⋅ 
   ⋅     ⋅     ⋅    8.0  -10.0  -12.0   14.0     ⋅      ⋅      ⋅ 
   ⋅     ⋅    6.0  -8.0     ⋅      ⋅   -14.0   16.0     ⋅      ⋅ 
   ⋅    4.0  -6.0    ⋅      ⋅      ⋅      ⋅   -16.0   18.0     ⋅ 
  2.0  -4.0    ⋅     ⋅      ⋅      ⋅      ⋅      ⋅   -18.0   20.0</code></pre><pre><code class="language-julia hljs">hessian(f_sparse_scalar, sparse_second_order_backend, float.(1:10))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">10×10 SparseArrays.SparseMatrixCSC{Float64, Int64} with 52 stored entries:
  144.0   -32.0      ⋅       ⋅       ⋅   …      ⋅        ⋅    -144.0    160.0
  -32.0    96.0   -96.0      ⋅       ⋅          ⋅    -256.0    576.0   -320.0
     ⋅    -96.0   256.0  -192.0      ⋅      -336.0    768.0   -432.0       ⋅ 
     ⋅       ⋅   -192.0   480.0  -320.0      896.0   -512.0       ⋅        ⋅ 
     ⋅       ⋅       ⋅   -320.0   368.0     -560.0       ⋅        ⋅        ⋅ 
     ⋅       ⋅       ⋅   -384.0   480.0  …  -672.0       ⋅        ⋅        ⋅ 
     ⋅       ⋅   -336.0   896.0  -560.0     1536.0   -896.0       ⋅        ⋅ 
     ⋅   -256.0   768.0  -512.0      ⋅      -896.0   2016.0  -1152.0       ⋅ 
 -144.0   576.0  -432.0      ⋅       ⋅          ⋅   -1152.0   2560.0  -1440.0
  160.0  -320.0      ⋅       ⋅       ⋅          ⋅        ⋅   -1440.0   1728.0</code></pre><h2 id="Sparse-preparation"><a class="docs-heading-anchor" href="#Sparse-preparation">Sparse preparation</a><a id="Sparse-preparation-1"></a><a class="docs-heading-anchor-permalink" href="#Sparse-preparation" title="Permalink"></a></h2><p>In the examples above, we didn&#39;t use preparation. Sparse preparation is more costly than dense preparation, but it is even more essential. Indeed, once preparation is done, sparse differentiation is much faster than dense differentiation, because it makes fewer calls to the underlying function. The speedup becomes very visible in large dimensions.</p><pre><code class="language-julia hljs">n = 1000
jac_extras_dense = prepare_jacobian(f_sparse_vector, dense_first_order_backend, randn(n));
jac_extras_sparse = prepare_jacobian(f_sparse_vector, sparse_first_order_backend, randn(n));</code></pre><pre><code class="language-julia hljs">@benchmark jacobian($f_sparse_vector, $dense_first_order_backend, $(randn(n)), $jac_extras_dense) evals=1</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 613 samples with 1 evaluation.
 Range <span class="sgr90">(</span><span class="sgr36"><span class="sgr1">min</span></span> … <span class="sgr35">max</span><span class="sgr90">):  </span><span class="sgr36"><span class="sgr1">4.645 ms</span></span> … <span class="sgr35">24.934 ms</span>  <span class="sgr90">┊</span> GC <span class="sgr90">(</span>min … max<span class="sgr90">): </span> 0.00% … 32.08%
 Time  <span class="sgr90">(</span><span class="sgr34"><span class="sgr1">median</span></span><span class="sgr90">):     </span><span class="sgr34"><span class="sgr1">6.556 ms              </span></span><span class="sgr90">┊</span> GC <span class="sgr90">(</span>median<span class="sgr90">):    </span>11.56%
 Time  <span class="sgr90">(</span><span class="sgr32"><span class="sgr1">mean</span></span> ± <span class="sgr32">σ</span><span class="sgr90">):   </span><span class="sgr32"><span class="sgr1">6.996 ms</span></span> ± <span class="sgr32"> 2.397 ms</span>  <span class="sgr90">┊</span> GC <span class="sgr90">(</span>mean ± σ<span class="sgr90">):  </span>11.45% ±  9.23%

  █▂  ▁▃    <span class="sgr34">▃</span>█ <span class="sgr32"> </span>                                              
  ██▁▂██▃▃▄▇<span class="sgr34">█</span>█▃<span class="sgr32">▃</span>▅▂▂▂▂▂▃▂▂▁▃▃▃▄▄▃▃▃▃▄▄▃▃▂▂▂▂▁▁▁▂▂▂▂▂▁▁▁▁▁▁▁▁▂ ▃
  4.65 ms<span class="sgr90">        Histogram: frequency by time</span>        15.2 ms <span class="sgr1">&lt;</span>

 Memory estimate<span class="sgr90">: </span><span class="sgr33">57.62 MiB</span>, allocs estimate<span class="sgr90">: </span><span class="sgr33">1011</span>.</code></pre><pre><code class="language-julia hljs">@benchmark jacobian($f_sparse_vector, $sparse_first_order_backend, $(randn(n)), $jac_extras_sparse) evals=1</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range <span class="sgr90">(</span><span class="sgr36"><span class="sgr1">min</span></span> … <span class="sgr35">max</span><span class="sgr90">):  </span><span class="sgr36"><span class="sgr1">56.716 μs</span></span> … <span class="sgr35"> 10.289 ms</span>  <span class="sgr90">┊</span> GC <span class="sgr90">(</span>min … max<span class="sgr90">): </span> 0.00% … 57.80%
 Time  <span class="sgr90">(</span><span class="sgr34"><span class="sgr1">median</span></span><span class="sgr90">):     </span><span class="sgr34"><span class="sgr1">65.192 μs               </span></span><span class="sgr90">┊</span> GC <span class="sgr90">(</span>median<span class="sgr90">):    </span> 0.00%
 Time  <span class="sgr90">(</span><span class="sgr32"><span class="sgr1">mean</span></span> ± <span class="sgr32">σ</span><span class="sgr90">):   </span><span class="sgr32"><span class="sgr1">76.987 μs</span></span> ± <span class="sgr32">146.711 μs</span>  <span class="sgr90">┊</span> GC <span class="sgr90">(</span>mean ± σ<span class="sgr90">):  </span>10.38% ±  7.59%

   ▄<span class="sgr34">█</span>▅▂▂<span class="sgr32">▁</span>                                                      ▁
  ██<span class="sgr34">█</span>███<span class="sgr32">█</span>▇▆██▅▄▁▃▃▁▁▁▁▁▁▁▁▁▁▁▁▁▃▁▁▁▁▁▁▁▁▁▃▁▁▁▁▁▁▁▁▁▁▁▁▁▃▃▃▃▇█▇ █
  56.7 μs<span class="sgr90">       Histogram: <span class="sgr1">log(</span>frequency<span class="sgr1">)</span> by time</span>       261 μs <span class="sgr1">&lt;</span>

 Memory estimate<span class="sgr90">: </span><span class="sgr33">511.64 KiB</span>, allocs estimate<span class="sgr90">: </span><span class="sgr33">35</span>.</code></pre><script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
mermaid.initialize({
    startOnLoad: true,
    theme: "neutral"
});
</script></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../tutorial1/">« Basics</a><a class="docs-footer-nextpage" href="../operators/">Operators »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.1 on <span class="colophon-date" title="Tuesday 28 May 2024 09:28">Tuesday 28 May 2024</span>. Using Julia version 1.10.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
